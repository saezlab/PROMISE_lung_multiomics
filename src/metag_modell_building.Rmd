---
title: "Pancreatic Cancer Model Building"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

SIAMCAT needs a feature matrix (matrix or data.frame) 
features (in rows) samples (in columns)
metadata in a data.frame, samples as row names

```{r setup, include=FALSE}
# load library
library("tidyverse")
library("matrixStats")
library("SIAMCAT")
library("ggrepel")
library("dplyr")
library("plyr")
library("readxl")
# check siamcat version
packageVersion("SIAMCAT")
PARAM <- list()
PARAM$folder.R <- paste0(getwd(), "/")
PARAM$folder <- gsub("src/", "", PARAM$folder.R)
PARAM$folder.input <- paste0(PARAM$folder, "input/")
PARAM$folder.Rdata <- paste0(PARAM$folder, "Rdata/")
PARAM$folder.data <- paste0(PARAM$folder, "data/")
PARAM$folder.output <- paste0(PARAM$folder, "output/metaG/")

# load data metag motu and genes

```
###############################################################################
Function to run siamcat with centered log transformation (clr) normalization
10 fold cross validation and 10 fold re-sampling
Confounder check based on fisher exact test
###############################################################################
```{r}
runsiamcat <- function(featTable, metaTable, label, fileName, case, ml, norm){
  dim(featTable)
  # create SIAMCAT object and classify
  siamcat <- siamcat(feat=featTable, meta=metaTable, label=label, case=case)
  
  # filter based on abundance 
  siamcat <- filter.features(siamcat, filter.method = 'abundance', 
                            cutoff=0.001, verbose=3)
  check.confounders(siamcat, fn.plot = paste0(PARAM$folder.output, 
                            fileName, 'confounders.pdf'),
                            meta.in=metatest, verbose = 3)
        
  # normalize with log.clr
  siamcat <- normalize.features(siamcat, norm.method = "log.clr", 
                                feature.type = 'filtered',
                                norm.param = list(log.n0=1e-05, sd.min.q=1))
                                      
  # compute associations 
  siamcat <- check.associations(siamcat, feature.type = 'normalized')
        
  # train model
  siamcat <- create.data.split(siamcat, num.folds =10, num.resample = 10)  
  siamcat <- train.model(siamcat, method = "lasso_ll", verbose = 2)
  siamcat <- make.predictions(siamcat)
  siamcat <- evaluate.predictions(siamcat)    
  print(siamcat@eval_data$auroc)
  # evaluation plot
  model.evaluation.plot(siamcat, fn.plot = paste0(PARAM$folder.output, Sys.Date(), '.',
                                                  fileName, 'eval.plot.pdf'))
  # interpretation plot
  model.interpretation.plot(siamcat, fn.plot = paste0(PARAM$folder.output, 
                           Sys.Date(), '.', fileName,'interpret.plot.pdf'),
                           consens.thres = 0.5,
                          heatmap.type = 'zscore')
        
  # save siamcat object
  save(siamcat, file = paste0(PARAM$folder.output, fileName, 'siamcat.Rdata'))
  return(siamcat) 
}

```

###############################################################################
Spanish MetaG Taxonomic Modelling
###############################################################################

```{r}
# choose the meta variables to test
metatest = c( "Age", "Sex","Vital_status", "Timepoint",   
             "days_to_death" ,"ReadCount (Homo)")
metatest = c("CHEMO", "IMMUN", "TARGET",  "Age", "Sex","Vital_status", "Timepoint",   
             "days_to_death" ,"ReadCount (Homo)")
# run siamcat
metas=as.data.frame(meta)
overlap_columns <- intersect(metas$ID, colnames(featTable))
metas_subset <- metas %>%
  filter(ID %in% overlap_columns)
metas_subset <- metas_subset[!duplicated(metas_subset$ID), ]
rownames(metas_subset) <- metas_subset$ID
# Check if row names are identical to column names in 'feat'
row_names_identical <- all(rownames(metas_subset) %in% colnames(featTable)) && length(rownames(metas_subset)) == ncol(featTable)
# Print the result
print(row_names_identical)


# run model
runsiamcat(featTable, metas_subset,"IMMUN", "IMMUN", "0")
runsiamcat(featTable, metas_subset,"CHEMO", "CHEMO", "0")
```

###############################################################################
Add confounders to metaG models
###############################################################################

```{r}
# load models
load(paste0(PARAM$folder.Rdata, "st.naive.Rdata"))
siamcat.pc <- siamcat

load(paste0(PARAM$folder.Rdata, "st.constrain.enriched.Rdata"))
siamcat.pos <- siamcat

# add confounders to model
add.meta <- function(x, n){
  x <- add.meta.pred(x, pred.names = n, verbose=3)
  x <- train.model(x, method='lasso_ll', verbose=2, perform.fs = TRUE,
                   param.fs = list(thres.fs=50, method.fs='gFC', 
                                   direction='positive'))
  x <- make.predictions(x)
  x <- evaluate.predictions(x)
  return(x)
}
# combine with naive model
siamcat.jau <- add.meta(siamcat.pc, 'jaundice')
siamcat.col <- add.meta(siamcat.pc, 'cholesterol')


model.evaluation.plot('constrained-enrichment model'= siamcat.pos,
                      'naive model'= siamcat.pc,
                      fn.plot = paste0(PARAM$folder.results,  Sys.Date(),
                                       'confounders.interpret.pdf'))

# save confounder Rdata
save(siamcat.pc, siamcat.pos,
     file = paste0(PARAM$folder.files, Sys.Date(), 'confounder.RData'))
```


```{r session_info}
sessionInfo()
```


